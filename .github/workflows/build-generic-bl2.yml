name: Build OpenWrt with Generic BL2

on:
  push:
    branches: [main]
    paths:
      - 'dts/**'
      - 'config/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version'
        required: false
        default: 'v24.10.4'
        type: choice
        options:
          - v24.10.4

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare FIP file
        run: |
          echo "=== 准备厂家FIP文件 ==="
          chmod +x scripts/prepare-fip-only.sh
          ./scripts/prepare-fip-only.sh

          echo "FIP文件详情："
          ls -lh prebuilt/zbt-z8102ax-v2/

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget \
            unzip python3 python3-setuptools rsync subversion swig \
            time xxd file
          
          # 配置git以提高网络容错性
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 600
          git config --global http.postBuffer 524288000

      - name: Clone OpenWrt
        run: |
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version || 'v24.10.4' }}"
          echo "使用OpenWrt版本: ${OPENWRT_VERSION}"
          
          # 添加重试逻辑以应对网络问题
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "尝试克隆OpenWrt仓库 (尝试 $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            if git clone --depth=1 https://github.com/openwrt/openwrt.git -b ${OPENWRT_VERSION}; then
              echo "✓ 克隆成功"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((RETRY_COUNT * 10))
                echo "✗ 克隆失败，等待 ${WAIT_TIME} 秒后重试..."
                sleep $WAIT_TIME
              else
                echo "✗ 克隆失败，已达到最大重试次数"
                exit 1
              fi
            fi
          done

      - name: Integrate device support
        run: |
          cd openwrt

          echo "=== 集成ZBT设备支持 ==="

          # 1. 复制DTS
          cp ../dts/mt7981-zbt-z8102ax-v2.dts target/linux/mediatek/dts/

          # 2. 添加设备定义（使用通用BL2）
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          define Device/zbt_z8102ax_v2_emmc
            DEVICE_VENDOR := Zbtlink
            DEVICE_MODEL := ZBT-Z8102AX-V2 (eMMC)
            DEVICE_DTS := mt7981-zbt-z8102ax-v2
            DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware mt7981-wo-firmware kmod-usb3 kmod-usb-storage e2fsprogs f2fsck mkf2fs
            UBINIZE_OPTS := -E 5
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            IMAGE_SIZE := 65536k
            KERNEL_IN_UBI := 1
            IMAGES := sysupgrade.bin
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
            ARTIFACTS := emmc-preloader.bin emmc-bl31-uboot.fip
            ARTIFACT/emmc-preloader.bin := mt7981-bl2 emmc-ddr4
            ARTIFACT/emmc-bl31-uboot.fip := copy-file $(TOPDIR)/prebuilt/zbt-z8102ax-v2/fip.bin
          endef
          TARGET_DEVICES += zbt_z8102ax_v2_emmc
          EOF

          # 3. 复制FIP文件
          mkdir -p prebuilt/zbt-z8102ax-v2
          cp ../prebuilt/zbt-z8102ax-v2/fip.bin prebuilt/zbt-z8102ax-v2/

          # 4. 验证设备定义是否添加成功
          echo "=== 验证设备定义 ==="
          if grep -q "define Device/zbt_z8102ax_v2_emmc" target/linux/mediatek/image/filogic.mk; then
            echo "✓ 设备定义已成功添加"
            echo "设备定义内容："
            grep -A 15 "define Device/zbt_z8102ax_v2_emmc" target/linux/mediatek/image/filogic.mk
          else
            echo "✗ 错误：设备定义添加失败"
            exit 1
          fi

          echo "设备集成完成"

      - name: Configure and build
        run: |
          cd openwrt

          # 配置下载镜像源以提高可靠性
          echo "=== 配置下载镜像源 ==="
          cat >> .config << 'EOF'
          # 使用多个镜像源提高下载成功率
          CONFIG_DOWNLOAD_FOLDER=""
          CONFIG_LOCALMIRROR=""
          EOF
          
          # 设置环境变量启用镜像
          export DOWNLOAD_TIMEOUT=60

          # 更新feeds（带重试逻辑）
          echo "=== 更新feeds ==="
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "尝试更新feeds (尝试 $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            if ./scripts/feeds update -a; then
              echo "✓ Feeds更新成功"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((RETRY_COUNT * 10))
                echo "✗ Feeds更新失败，等待 ${WAIT_TIME} 秒后重试..."
                sleep $WAIT_TIME
              else
                echo "✗ Feeds更新失败，已达到最大重试次数"
                exit 1
              fi
            fi
          done
          
          # 安装feeds
          ./scripts/feeds install -a

          # 应用配置
          cp ../config/openwrt-zbt-z8102ax-v2.config .config
          make defconfig

          # 下载软件包（带重试逻辑）
          echo "=== 下载软件包 ==="
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "尝试下载软件包 (尝试 $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            if make download -j$(nproc); then
              echo "✓ 软件包下载成功"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((RETRY_COUNT * 15))
                echo "✗ 软件包下载失败，等待 ${WAIT_TIME} 秒后重试..."
                sleep $WAIT_TIME
                # 尝试清理可能损坏的下载文件（忽略错误以便重试）
                echo "清理可能损坏的下载..."
                make download -j1 || true
              else
                echo "✗ 软件包下载失败，已达到最大重试次数"
                echo "尝试以详细模式显示下载状态..."
                make download -j1 V=s || echo "详细下载失败"
                exit 1
              fi
            fi
          done

          # 开始编译
          echo "开始编译..."
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log

          # 检查结果
          if [ -f "bin/targets/mediatek/filogic/openwrt-mediatek-filogic-zbt_z8102ax_v2_emmc-squashfs-sysupgrade.bin" ]; then
            echo "编译成功！"
            echo "输出文件："
            ls -lh bin/targets/mediatek/filogic/*.bin
            ls -lh bin/targets/mediatek/filogic/*.fip 2>/dev/null || true
          else
            echo "编译失败"
            echo "查找可能的输出文件："
            find bin/targets/mediatek/filogic/ -name "*z8102ax*" -o -name "*.bin" | head -10
            tail -100 build.log
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-generic-bl2
          path: |
            openwrt/bin/targets/mediatek/filogic/*.bin
            openwrt/bin/targets/mediatek/filogic/*.fip
          retention-days: 90
