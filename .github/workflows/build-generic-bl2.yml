name: Build OpenWrt with Generic BL2

on:
  push:
    branches: [main]
    paths:
      - 'dts/**'
      - 'config/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version'
        required: false
        default: 'v24.07.0-rc4'
        type: choice
        options:
          - v24.07.0-rc4
          - v23.05.3
          - master

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare FIP file
        run: |
          echo "=== 准备厂家FIP文件 ==="
          chmod +x scripts/prepare-fip-only.sh
          ./scripts/prepare-fip-only.sh

          echo "FIP文件详情："
          ls -lh prebuilt/zbt-z8102ax-v2/

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget \
            unzip python3 python3-setuptools rsync subversion swig \
            time xxd file

      - name: Clone OpenWrt
        run: |
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version || 'v24.07.0-rc4' }}"
          echo "使用OpenWrt版本: ${OPENWRT_VERSION}"
          git clone --depth=1 https://github.com/openwrt/openwrt.git -b ${OPENWRT_VERSION}

      - name: Integrate device support
        run: |
          cd openwrt

          echo "=== 集成ZBT设备支持 ==="

          # 1. 复制DTS
          cp ../dts/mt7981-zbt-z8102ax-v2.dts target/linux/mediatek/dts/

          # 2. 添加设备定义（使用通用BL2）
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          define Device/zbt_z8102ax_v2_generic
            DEVICE_VENDOR := ZBT
            DEVICE_MODEL := Z8102AX V2 (Generic BL2)
            DEVICE_DTS := mt7981-zbt-z8102ax-v2
            DEVICE_DTS_DIR := $(DTS_DIR)/mediatek
            SUPPORTED_DEVICES := zbt,z8102ax-v2
            ARTIFACTS := emmc-preloader.bin emmc-bl31-uboot.fip
            ARTIFACT/emmc-preloader.bin := mt7981-bl2 emmc-ddr4 BL2_DEVICE=emmc
            ARTIFACT/emmc-bl31-uboot.fip := copy-file $(TOPDIR)/prebuilt/zbt-z8102ax-v2/fip.bin
            DEVICE_PACKAGES := kmod-mt7915e kmod-mt7915-firmware kmod-usb3 kmod-usb-storage
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            KERNEL_IN_UBI := 1
            IMAGES := sysupgrade.bin
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
          endef
          TARGET_DEVICES += zbt_z8102ax_v2_generic
          EOF

          # 3. 复制FIP文件
          mkdir -p prebuilt/zbt-z8102ax-v2
          cp ../prebuilt/zbt-z8102ax-v2/fip.bin prebuilt/zbt-z8102ax-v2/

          echo "设备集成完成"

      - name: Configure and build
        run: |
          cd openwrt

          # 更新feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 应用配置
          cp ../config/openwrt-mt7981-zbt-z8102ax-v2.config .config
          make defconfig

          # 下载软件包
          make download -j$(nproc)

          # 开始编译
          echo "开始编译..."
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log

          # 检查结果
          if [ -f "bin/targets/mediatek/filogic/openwrt-mediatek-filogic-zbt_z8102ax_v2_generic-squashfs-sysupgrade.bin" ]; then
            echo "编译成功！"
            echo "输出文件："
            ls -lh bin/targets/mediatek/filogic/*.bin
          else
            echo "编译失败"
            tail -100 build.log
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-generic-bl2
          path: |
            openwrt/bin/targets/mediatek/filogic/*.bin
            openwrt/bin/targets/mediatek/filogic/*.fip
          retention-days: 90
