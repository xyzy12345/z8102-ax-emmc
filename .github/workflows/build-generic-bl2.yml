name: Build OpenWrt with Generic BL2

on:
  push:
    branches: [main]
    paths:
      - 'dts/**'
      - 'config/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version'
        required: false
        default: 'v24.10.4'
        type: choice
        options:
          - v24.10.4

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare FIP file
        run: |
          echo "=== 准备厂家FIP文件 ==="
          chmod +x scripts/prepare-fip-only.sh
          ./scripts/prepare-fip-only.sh

          echo "FIP文件详情："
          ls -lh prebuilt/zbt-z8102ax-v2/

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget \
            unzip python3 python3-setuptools rsync subversion swig \
            time xxd file

      - name: Clone OpenWrt
        run: |
          OPENWRT_VERSION="${{ github.event.inputs.openwrt_version || 'v24.10.4' }}"
          echo "使用OpenWrt版本: ${OPENWRT_VERSION}"
          git clone --depth=1 https://github.com/openwrt/openwrt.git -b ${OPENWRT_VERSION}

      - name: Integrate device support
        run: |
          cd openwrt

          echo "=== 集成ZBT设备支持 ==="

          # 1. 复制DTS
          cp ../dts/mt7981-zbt-z8102ax-v2.dts target/linux/mediatek/dts/

          # 2. 添加设备定义（使用通用BL2）
          cat >> target/linux/mediatek/image/filogic.mk << 'EOF'

          define Device/zbt_z8102ax_v2_emmc
            DEVICE_VENDOR := Zbtlink
            DEVICE_MODEL := ZBT-Z8102AX-V2 (eMMC)
            DEVICE_DTS := mt7981-zbt-z8102ax-v2
            DEVICE_DTS_DIR := ../dts
            DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware mt7981-wo-firmware kmod-usb3 kmod-usb-storage e2fsprogs f2fsck mkf2fs
            UBINIZE_OPTS := -E 5
            BLOCKSIZE := 128k
            PAGESIZE := 2048
            IMAGE_SIZE := 65536k
            KERNEL_IN_UBI := 1
            IMAGES := sysupgrade.bin
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
            ARTIFACTS := emmc-preloader.bin emmc-bl31-uboot.fip
            ARTIFACT/emmc-preloader.bin := mt7981-bl2 emmc-ddr4
            ARTIFACT/emmc-bl31-uboot.fip := copy-file $(TOPDIR)/prebuilt/zbt-z8102ax-v2/fip.bin
          endef
          TARGET_DEVICES += zbt_z8102ax_v2_emmc
          EOF

          # 3. 复制FIP文件
          mkdir -p prebuilt/zbt-z8102ax-v2
          cp ../prebuilt/zbt-z8102ax-v2/fip.bin prebuilt/zbt-z8102ax-v2/

          # 4. 验证设备定义是否添加成功
          echo "=== 验证设备定义 ==="
          if grep -q "define Device/zbt_z8102ax_v2_emmc" target/linux/mediatek/image/filogic.mk; then
            echo "✓ 设备定义已成功添加"
            echo "设备定义内容："
            grep -A 15 "define Device/zbt_z8102ax_v2_emmc" target/linux/mediatek/image/filogic.mk
          else
            echo "✗ 错误：设备定义添加失败"
            exit 1
          fi

          echo "设备集成完成"

      - name: Configure and build
        run: |
          cd openwrt

          # 更新feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 应用配置
          cp ../config/openwrt-mt7981-zbt-z8102ax-v2.config .config
          make defconfig

          # 下载软件包
          make download -j$(nproc)

          # 开始编译
          echo "开始编译..."
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log

          # 检查结果
          if [ -f "bin/targets/mediatek/filogic/openwrt-mediatek-filogic-zbt_z8102ax_v2_emmc-squashfs-sysupgrade.bin" ]; then
            echo "编译成功！"
            echo "输出文件："
            ls -lh bin/targets/mediatek/filogic/*.bin
            ls -lh bin/targets/mediatek/filogic/*.fip 2>/dev/null || true
          else
            echo "编译失败"
            echo "查找可能的输出文件："
            find bin/targets/mediatek/filogic/ -name "*z8102ax*" -o -name "*.bin" | head -10
            tail -100 build.log
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-generic-bl2
          path: |
            openwrt/bin/targets/mediatek/filogic/*.bin
            openwrt/bin/targets/mediatek/filogic/*.fip
          retention-days: 90
